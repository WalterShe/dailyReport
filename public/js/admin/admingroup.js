// Generated by CoffeeScript 1.10.0
(function() {
  var AdminGroupViewModel, init;

  AdminGroupViewModel = function() {
    var self;
    self = this;
    self.departments = ko.observableArray([]);
    self.selectedDepartment = ko.observable(null);
    self.users = ko.observableArray([]);
    self.selectedUser = ko.observable(null);
    self.admins = ko.observableArray([]);
    self.valid = ko.computed(function() {
      return self.selectedDepartment() && self.selectedUser();
    });
    self.submit = function() {
      var user;
      if (!self.valid()) {
        console.log("fail: 必须选择一个成员");
      }
      user = self.selectedUser();
      return UserModel.setAdministrator(user["id"], function(response) {
        if (response.state === 0) {
          return;
        }
        return self.admins.push(user);
      });
    };
    return self;
  };

  init = function() {
    var adminvm, confirm, deleteAdmin, getAdmins, getUsersByDepartmentId;
    adminvm = new AdminGroupViewModel();
    ko.applyBindings(adminvm);
    DepartmemtModel.getAllDepartments(function(response) {
      return adminvm.departments(response.data);
    });
    UserModel.getAllUsers(function(response) {
      var users;
      if (response.state === 0) {
        return;
      }
      users = response.data;
      UserModel.getAdmins(function(response) {
        var adminIds, admins;
        if (response.state === 0) {
          return;
        }
        adminIds = response.data;
        admins = getAdmins(users, adminIds);
        return adminvm.admins(admins);
      });
      return null;
    });
    getAdmins = function(allUsers, adminIds) {
      var adminId, i, j, len, len1, result, user;
      result = [];
      for (i = 0, len = adminIds.length; i < len; i++) {
        adminId = adminIds[i];
        for (j = 0, len1 = allUsers.length; j < len1; j++) {
          user = allUsers[j];
          if (adminId === user["id"]) {
            result.push(user);
            break;
          }
        }
      }
      return result;
    };
    $("#depar").change(function() {
      var admin, admins, departmentId, departmentUsers, i, len, ref, results, user, users;
      departmentId = (ref = adminvm.selectedDepartment()) != null ? ref['id'] : void 0;
      users = UserModel.getLocalAllUsers();
      departmentUsers = getUsersByDepartmentId(departmentId, users);
      adminvm.users(departmentUsers);
      admins = adminvm.admins();
      results = [];
      for (i = 0, len = admins.length; i < len; i++) {
        admin = admins[i];
        results.push((function() {
          var j, len1, results1;
          results1 = [];
          for (j = 0, len1 = users.length; j < len1; j++) {
            user = users[j];
            if (user["id"] === admin["id"]) {
              adminvm.users.remove(user);
              break;
            } else {
              results1.push(void 0);
            }
          }
          return results1;
        })());
      }
      return results;
    });
    getUsersByDepartmentId = function(departmentId, allUsers) {
      var i, len, result, user;
      result = [];
      if (!departmentId) {
        return result;
      }
      for (i = 0, len = allUsers.length; i < len; i++) {
        user = allUsers[i];
        if (departmentId === user["departmentId"]) {
          result.push(user);
        }
      }
      return result;
    };
    $("#adminlist").on("click", "a.delete", function(event) {
      var userId;
      userId = $(this).attr("userid");
      return confirm(userId);
    });
    deleteAdmin = function(userId) {
      return UserModel.deleteAdministrator(userId, function(response) {
        var admin, admins, i, len;
        if (response.state === 0) {
          return;
        }
        admins = adminvm.admins();
        for (i = 0, len = admins.length; i < len; i++) {
          admin = admins[i];
          if (admin["id"] === userId) {
            return adminvm.admins.remove(admin);
          }
        }
      });
    };
    confirm = function(userId) {
      return $("#dialog-confirm").dialog({
        dialogClass: "no-close",
        resizable: false,
        height: 160,
        modal: true,
        buttons: {
          "删除": function() {
            deleteAdmin(userId);
            return $(this).dialog("close");
          },
          Cancel: function() {
            return $(this).dialog("close");
          }
        }
      });
    };
    $("#adminlist").on("mouseenter", "li", function(event) {
      return $(this).addClass('itemOver');
    });
    return $("#adminlist").on("mouseleave", "li", function(event) {
      return $(this).removeClass('itemOver');
    });
  };

  init();

}).call(this);
